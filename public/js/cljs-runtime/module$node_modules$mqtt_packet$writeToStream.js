shadow$provide.module$node_modules$mqtt_packet$writeToStream=function(global,require,module,exports){function generate(packet,stream,opts){debug("generate called");stream.cork&&(stream.cork(),nextTick(uncork,stream));toGenerate&&(toGenerate=!1,generateCache());debug("generate: packet.cmd: %s",packet.cmd);switch(packet.cmd){case "connect":return connect(packet,stream,opts);case "connack":a:{opts=opts?opts.protocolVersion:4;packet=packet||{};var rc=5===opts?packet.reasonCode:packet.returnCode,properties=
packet.properties,length=2;if("number"!==typeof rc)stream.emit("error",Error("Invalid return code")),stream=!1;else{var propertiesData=null;if(5===opts){propertiesData=getProperties(stream,properties);if(!propertiesData){stream=!1;break a}length+=propertiesData.length}stream.write(protocol.CONNACK_HEADER);writeVarByteInt(stream,length);stream.write(packet.sessionPresent?protocol.SESSIONPRESENT_HEADER:zeroBuf);stream.write(Buffer.from([rc]));null!=propertiesData&&propertiesData.write();stream=!0}}return stream;
case "publish":a:{debug("publish: packet: %o",packet);opts=opts?opts.protocolVersion:4;packet=packet||{};rc=packet.qos||0;properties=packet.retain?protocol.RETAIN_MASK:0;length=packet.topic;var payload=packet.payload||empty,id=packet.messageId,properties$jscomp$0=packet.properties,length$jscomp$0=0;if("string"===typeof length)length$jscomp$0+=Buffer.byteLength(length)+2;else if(Buffer.isBuffer(length))length$jscomp$0+=length.length+2;else{stream.emit("error",Error("Invalid topic"));stream=!1;break a}length$jscomp$0=
Buffer.isBuffer(payload)?length$jscomp$0+payload.length:length$jscomp$0+Buffer.byteLength(payload);if(rc&&"number"!==typeof id)stream.emit("error",Error("Invalid messageId")),stream=!1;else{rc&&(length$jscomp$0+=2);propertiesData=null;if(5===opts){propertiesData=getProperties(stream,properties$jscomp$0);if(!propertiesData){stream=!1;break a}length$jscomp$0+=propertiesData.length}stream.write(protocol.PUBLISH_HEADER[rc][packet.dup?1:0][properties?1:0]);writeVarByteInt(stream,length$jscomp$0);writeNumber(stream,
byteLength(length));stream.write(length);0<rc&&writeNumber(stream,id);null!=propertiesData&&propertiesData.write();debug("publish: payload: %o",payload);stream=stream.write(payload)}}return stream;case "puback":case "pubrec":case "pubrel":case "pubcomp":a:if(propertiesData=opts?opts.protocolVersion:4,id=packet||{},packet=id.cmd||"puback",rc=id.messageId,properties=id.dup&&"pubrel"===packet?protocol.DUP_MASK:0,length=0,payload=id.reasonCode,properties$jscomp$0=id.properties,length$jscomp$0=5===propertiesData?
3:2,"pubrel"===packet&&(length=1),"number"!==typeof rc)stream.emit("error",Error("Invalid messageId")),stream=!1;else{id=null;if(5===propertiesData&&"object"===typeof properties$jscomp$0){id=getPropertiesByMaximumPacketSize(stream,properties$jscomp$0,opts,length$jscomp$0);if(!id){stream=!1;break a}length$jscomp$0+=id.length}stream.write(protocol.ACKS[packet][length][properties][0]);writeVarByteInt(stream,length$jscomp$0);writeNumber(stream,rc);5===propertiesData&&stream.write(Buffer.from([payload]));
null!==id&&id.write();stream=!0}return stream;case "subscribe":return subscribe(packet,stream,opts);case "suback":return suback(packet,stream,opts);case "unsubscribe":return unsubscribe(packet,stream,opts);case "unsuback":return unsuback(packet,stream,opts);case "pingreq":case "pingresp":return stream.write(protocol.EMPTY[packet.cmd]);case "disconnect":a:{propertiesData=opts?opts.protocolVersion:4;rc=packet||{};packet=rc.reasonCode;rc=rc.properties;properties=5===propertiesData?1:0;length=null;if(5===
propertiesData){length=getPropertiesByMaximumPacketSize(stream,rc,opts,properties);if(!length){stream=!1;break a}properties+=length.length}stream.write(Buffer.from([protocol.codes.disconnect<<4]));writeVarByteInt(stream,properties);5===propertiesData&&stream.write(Buffer.from([packet]));null!==length&&length.write();stream=!0}return stream;case "auth":return propertiesData=opts?opts.protocolVersion:4,rc=packet||{},packet=rc.reasonCode,properties=rc.properties,rc=5===propertiesData?1:0,5!==propertiesData&&
stream.emit("error",Error("Invalid mqtt version for auth packet")),(opts=getPropertiesByMaximumPacketSize(stream,properties,opts,rc))?(rc+=opts.length,stream.write(Buffer.from([protocol.codes.auth<<4])),writeVarByteInt(stream,rc),stream.write(Buffer.from([packet])),null!==opts&&opts.write(),stream=!0):stream=!1,stream;default:return stream.emit("error",Error("Unknown command")),!1}}function uncork(stream){stream.uncork()}function connect(packet,stream,opts){var settings=packet||{};const protocolId=
settings.protocolId||"MQTT";packet=settings.protocolVersion||4;opts=settings.will;let clean=settings.clean;const keepalive=settings.keepalive||0,clientId=settings.clientId||"",username=settings.username,password=settings.password;var properties=settings.properties;void 0===clean&&(clean=!0);let length=0;if(!protocolId||"string"!==typeof protocolId&&!Buffer.isBuffer(protocolId))return stream.emit("error",Error("Invalid protocolId")),!1;length+=protocolId.length+2;if(3!==packet&&4!==packet&&5!==packet)return stream.emit("error",
Error("Invalid protocol version")),!1;length+=1;if(("string"===typeof clientId||Buffer.isBuffer(clientId))&&(clientId||4<=packet)&&(clientId||clean))length+=Buffer.byteLength(clientId)+2;else{if(4>packet)return stream.emit("error",Error("clientId must be supplied before 3.1.1")),!1;if(0===1*clean)return stream.emit("error",Error("clientId must be given if cleanSession set to 0")),!1}if("number"!==typeof keepalive||0>keepalive||65535<keepalive||0!==keepalive%1)return stream.emit("error",Error("Invalid keepalive")),
!1;length=length+2+1;if(5===packet){var propertiesData=getProperties(stream,properties);if(!propertiesData)return!1;length+=propertiesData.length}if(opts){if("object"!==typeof opts)return stream.emit("error",Error("Invalid will")),!1;if(opts.topic&&"string"===typeof opts.topic)length+=Buffer.byteLength(opts.topic)+2;else return stream.emit("error",Error("Invalid will topic")),!1;length+=2;if(opts.payload)if(0<=opts.payload.length)length="string"===typeof opts.payload?length+Buffer.byteLength(opts.payload):
length+opts.payload.length;else return stream.emit("error",Error("Invalid will payload")),!1;var willProperties={};if(5===packet){willProperties=getProperties(stream,opts.properties);if(!willProperties)return!1;length+=willProperties.length}}properties=!1;if(null!=username)if(isStringOrBuffer(username))properties=!0,length+=Buffer.byteLength(username)+2;else return stream.emit("error",Error("Invalid username")),!1;if(null!=password){if(!properties)return stream.emit("error",Error("Username is required to use password")),
!1;if(isStringOrBuffer(password))length+=byteLength(password)+2;else return stream.emit("error",Error("Invalid password")),!1}stream.write(protocol.CONNECT_HEADER);writeVarByteInt(stream,length);writeStringOrBuffer(stream,protocolId);settings.bridgeMode&&(packet+=128);stream.write(131===packet?protocol.VERSION131:132===packet?protocol.VERSION132:4===packet?protocol.VERSION4:5===packet?protocol.VERSION5:protocol.VERSION3);settings=0|(null!=username?protocol.USERNAME_MASK:0);settings|=null!=password?
protocol.PASSWORD_MASK:0;settings|=opts&&opts.retain?protocol.WILL_RETAIN_MASK:0;settings|=opts&&opts.qos?opts.qos<<protocol.WILL_QOS_SHIFT:0;settings|=opts?protocol.WILL_FLAG_MASK:0;settings|=clean?protocol.CLEAN_SESSION_MASK:0;stream.write(Buffer.from([settings]));writeNumber(stream,keepalive);5===packet&&propertiesData.write();writeStringOrBuffer(stream,clientId);opts&&(5===packet&&willProperties.write(),writeString(stream,opts.topic),writeStringOrBuffer(stream,opts.payload));null!=username&&writeStringOrBuffer(stream,
username);null!=password&&writeStringOrBuffer(stream,password);return!0}function subscribe(packet,stream,opts){debug("subscribe: packet: ");opts=opts?opts.protocolVersion:4;var settings=packet||{},dup=settings.dup?protocol.DUP_MASK:0,id=settings.messageId;packet=settings.subscriptions;var properties=settings.properties;settings=0;if("number"!==typeof id)return stream.emit("error",Error("Invalid messageId")),!1;settings+=2;let propertiesData=null;if(5===opts){propertiesData=getProperties(stream,properties);
if(!propertiesData)return!1;settings+=propertiesData.length}if("object"===typeof packet&&packet.length)for(properties=0;properties<packet.length;properties+=1){const itopic=packet[properties].topic;var iqos=packet[properties].qos;if("string"!==typeof itopic)return stream.emit("error",Error("Invalid subscriptions - invalid topic")),!1;if("number"!==typeof iqos)return stream.emit("error",Error("Invalid subscriptions - invalid qos")),!1;if(5===opts){if("boolean"!==typeof(packet[properties].nl||!1))return stream.emit("error",
Error("Invalid subscriptions - invalid No Local")),!1;if("boolean"!==typeof(packet[properties].rap||!1))return stream.emit("error",Error("Invalid subscriptions - invalid Retain as Published")),!1;iqos=packet[properties].rh||0;if("number"!==typeof iqos||2<iqos)return stream.emit("error",Error("Invalid subscriptions - invalid Retain Handling")),!1}settings+=Buffer.byteLength(itopic)+2+1}else return stream.emit("error",Error("Invalid subscriptions")),!1;debug("subscribe: writing to stream: %o",protocol.SUBSCRIBE_HEADER);
stream.write(protocol.SUBSCRIBE_HEADER[1][dup?1:0][0]);writeVarByteInt(stream,settings);writeNumber(stream,id);null!==propertiesData&&propertiesData.write();dup=!0;for(const sub of packet)settings=sub.qos,packet=+sub.nl,dup=+sub.rap,id=sub.rh,writeString(stream,sub.topic),settings=protocol.SUBSCRIBE_OPTIONS_QOS[settings],5===opts&&(settings|=packet?protocol.SUBSCRIBE_OPTIONS_NL:0,settings|=dup?protocol.SUBSCRIBE_OPTIONS_RAP:0,settings|=id?protocol.SUBSCRIBE_OPTIONS_RH[id]:0),dup=stream.write(Buffer.from([settings]));
return dup}function suback(packet,stream,opts){const version=opts?opts.protocolVersion:4;var settings=packet||{};packet=settings.messageId;const granted=settings.granted;settings=settings.properties;let length=0;if("number"!==typeof packet)return stream.emit("error",Error("Invalid messageId")),!1;length+=2;if("object"===typeof granted&&granted.length)for(var i=0;i<granted.length;i+=1){if("number"!==typeof granted[i])return stream.emit("error",Error("Invalid qos vector")),!1;length+=1}else return stream.emit("error",
Error("Invalid qos vector")),!1;i=null;if(5===version){i=getPropertiesByMaximumPacketSize(stream,settings,opts,length);if(!i)return!1;length+=i.length}stream.write(protocol.SUBACK_HEADER);writeVarByteInt(stream,length);writeNumber(stream,packet);null!==i&&i.write();return stream.write(Buffer.from(granted))}function unsubscribe(packet,stream,opts){opts=opts?opts.protocolVersion:4;var settings=packet||{},id=settings.messageId;const dup=settings.dup?protocol.DUP_MASK:0;packet=settings.unsubscriptions;
settings=settings.properties;let length=0;if("number"!==typeof id)return stream.emit("error",Error("Invalid messageId")),!1;length+=2;if("object"===typeof packet&&packet.length)for(var i=0;i<packet.length;i+=1){if("string"!==typeof packet[i])return stream.emit("error",Error("Invalid unsubscriptions")),!1;length+=Buffer.byteLength(packet[i])+2}else return stream.emit("error",Error("Invalid unsubscriptions")),!1;i=null;if(5===opts){i=getProperties(stream,settings);if(!i)return!1;length+=i.length}stream.write(protocol.UNSUBSCRIBE_HEADER[1][dup?
1:0][0]);writeVarByteInt(stream,length);writeNumber(stream,id);null!==i&&i.write();opts=!0;for(id=0;id<packet.length;id++)opts=writeString(stream,packet[id]);return opts}function unsuback(packet,stream,opts){const version=opts?opts.protocolVersion:4;var settings=packet||{};packet=settings.messageId;const dup=settings.dup?protocol.DUP_MASK:0,granted=settings.granted,properties=settings.properties;settings=settings.cmd;let length=2;if("number"!==typeof packet)return stream.emit("error",Error("Invalid messageId")),
!1;if(5===version)if("object"===typeof granted&&granted.length)for(var i=0;i<granted.length;i+=1){if("number"!==typeof granted[i])return stream.emit("error",Error("Invalid qos vector")),!1;length+=1}else return stream.emit("error",Error("Invalid qos vector")),!1;i=null;if(5===version){i=getPropertiesByMaximumPacketSize(stream,properties,opts,length);if(!i)return!1;length+=i.length}stream.write(protocol.ACKS[settings][0][dup][0]);writeVarByteInt(stream,length);writeNumber(stream,packet);null!==i&&
i.write();5===version&&stream.write(Buffer.from(granted));return!0}function writeVarByteInt(stream,num){if(num>protocol.VARBYTEINT_MAX)return stream.emit("error",Error(`Invalid variable byte integer: ${num}`)),!1;let buffer=varByteIntCache[num];buffer||(buffer=genBufVariableByteInt(num),16384>num&&(varByteIntCache[num]=buffer));debug("writeVarByteInt: writing to stream: %o",buffer);return stream.write(buffer)}function writeString(stream,string){const strlen=Buffer.byteLength(string);writeNumber(stream,
strlen);debug("writeString: %s",string);return stream.write(string,"utf8")}function writeStringPair(stream,name,value){writeString(stream,name);writeString(stream,value)}function writeNumberCached(stream,number){debug("writeNumberCached: number: %d",number);debug("writeNumberCached: %o",numCache[number]);return stream.write(numCache[number])}function writeNumberGenerated(stream,number){number=generateNumber(number);debug("writeNumberGenerated: %o",number);return stream.write(number)}function write4ByteNumber(stream,
number){number=generate4ByteBuffer(number);debug("write4ByteNumber: %o",number);return stream.write(number)}function writeStringOrBuffer(stream,toWrite){"string"===typeof toWrite?writeString(stream,toWrite):toWrite?(writeNumber(stream,toWrite.length),stream.write(toWrite)):writeNumber(stream,0)}function getProperties(stream,properties){function getLengthProperty(name$jscomp$0,value$jscomp$0){let length=0;switch(protocol.propertiesTypes[name$jscomp$0]){case "byte":if("boolean"!==typeof value$jscomp$0)return stream.emit("error",
Error(`Invalid ${name$jscomp$0}: ${value$jscomp$0}`)),!1;length+=2;break;case "int8":if("number"!==typeof value$jscomp$0||0>value$jscomp$0||255<value$jscomp$0)return stream.emit("error",Error(`Invalid ${name$jscomp$0}: ${value$jscomp$0}`)),!1;length+=2;break;case "binary":if(value$jscomp$0&&null===value$jscomp$0)return stream.emit("error",Error(`Invalid ${name$jscomp$0}: ${value$jscomp$0}`)),!1;length+=1+Buffer.byteLength(value$jscomp$0)+2;break;case "int16":if("number"!==typeof value$jscomp$0||0>
value$jscomp$0||65535<value$jscomp$0)return stream.emit("error",Error(`Invalid ${name$jscomp$0}: ${value$jscomp$0}`)),!1;length+=3;break;case "int32":if("number"!==typeof value$jscomp$0||0>value$jscomp$0||4294967295<value$jscomp$0)return stream.emit("error",Error(`Invalid ${name$jscomp$0}: ${value$jscomp$0}`)),!1;length+=5;break;case "var":if("number"!==typeof value$jscomp$0||0>value$jscomp$0||268435455<value$jscomp$0)return stream.emit("error",Error(`Invalid ${name$jscomp$0}: ${value$jscomp$0}`)),
!1;length+=1+Buffer.byteLength(genBufVariableByteInt(value$jscomp$0));break;case "string":if("string"!==typeof value$jscomp$0)return stream.emit("error",Error(`Invalid ${name$jscomp$0}: ${value$jscomp$0}`)),!1;length+=3+Buffer.byteLength(value$jscomp$0.toString());break;case "pair":if("object"!==typeof value$jscomp$0)return stream.emit("error",Error(`Invalid ${name$jscomp$0}: ${value$jscomp$0}`)),!1;length+=Object.getOwnPropertyNames(value$jscomp$0).reduce((result,name)=>{const currentValue=value$jscomp$0[name];
return result=Array.isArray(currentValue)?result+currentValue.reduce((currentLength,value)=>currentLength+=3+Buffer.byteLength(name.toString())+2+Buffer.byteLength(value.toString()),0):result+(3+Buffer.byteLength(name.toString())+2+Buffer.byteLength(value$jscomp$0[name].toString()))},0);break;default:return stream.emit("error",Error(`Invalid property ${name$jscomp$0}: ${value$jscomp$0}`)),!1}return length}if("object"!==typeof properties||null!=properties.length)return{length:1,write(){writeProperties(stream,
{},0)}};let propertiesLength=0;if(properties)for(const propName in properties){let propLength=0,propValueLength=0;const propValue=properties[propName];if(Array.isArray(propValue))for(let valueIndex=0;valueIndex<propValue.length;valueIndex++){propValueLength=getLengthProperty(propName,propValue[valueIndex]);if(!propValueLength)return!1;propLength+=propValueLength}else{propValueLength=getLengthProperty(propName,propValue);if(!propValueLength)return!1;propLength=propValueLength}if(!propLength)return!1;
propertiesLength+=propLength}return{length:Buffer.byteLength(genBufVariableByteInt(propertiesLength))+propertiesLength,write(){writeProperties(stream,properties,propertiesLength)}}}function getPropertiesByMaximumPacketSize(stream,properties,opts,length){const mayEmptyProps=["reasonString","userProperties"];opts=opts&&opts.properties&&opts.properties.maximumPacketSize?opts.properties.maximumPacketSize:0;var propertiesData=getProperties(stream,properties);if(opts)for(;length+propertiesData.length>opts;)if((propertiesData=
mayEmptyProps.shift())&&properties[propertiesData])delete properties[propertiesData],propertiesData=getProperties(stream,properties);else return!1;return propertiesData}function writeProperty(stream,propName,value$jscomp$0){switch(protocol.propertiesTypes[propName]){case "byte":stream.write(Buffer.from([protocol.properties[propName]]));stream.write(Buffer.from([+value$jscomp$0]));break;case "int8":stream.write(Buffer.from([protocol.properties[propName]]));stream.write(Buffer.from([value$jscomp$0]));
break;case "binary":stream.write(Buffer.from([protocol.properties[propName]]));writeStringOrBuffer(stream,value$jscomp$0);break;case "int16":stream.write(Buffer.from([protocol.properties[propName]]));writeNumber(stream,value$jscomp$0);break;case "int32":stream.write(Buffer.from([protocol.properties[propName]]));write4ByteNumber(stream,value$jscomp$0);break;case "var":stream.write(Buffer.from([protocol.properties[propName]]));writeVarByteInt(stream,value$jscomp$0);break;case "string":stream.write(Buffer.from([protocol.properties[propName]]));
writeString(stream,value$jscomp$0);break;case "pair":Object.getOwnPropertyNames(value$jscomp$0).forEach(name=>{const currentValue=value$jscomp$0[name];Array.isArray(currentValue)?currentValue.forEach(value=>{stream.write(Buffer.from([protocol.properties[propName]]));writeStringPair(stream,name.toString(),value.toString())}):(stream.write(Buffer.from([protocol.properties[propName]])),writeStringPair(stream,name.toString(),currentValue.toString()))});break;default:return stream.emit("error",Error(`Invalid property ${propName} value: ${value$jscomp$0}`)),
!1}}function writeProperties(stream,properties,propertiesLength){writeVarByteInt(stream,propertiesLength);for(const propName in properties)if(Object.prototype.hasOwnProperty.call(properties,propName)&&null!==properties[propName])if(propertiesLength=properties[propName],Array.isArray(propertiesLength))for(let valueIndex=0;valueIndex<propertiesLength.length;valueIndex++)writeProperty(stream,propName,propertiesLength[valueIndex]);else writeProperty(stream,propName,propertiesLength)}function byteLength(bufOrString){return bufOrString?
bufOrString instanceof Buffer?bufOrString.length:Buffer.byteLength(bufOrString):0}function isStringOrBuffer(field){return"string"===typeof field||field instanceof Buffer}var Buffer=require("module$node_modules$buffer$index").Buffer;const protocol=require("module$node_modules$mqtt_packet$constants"),empty=Buffer.allocUnsafe(0),zeroBuf=Buffer.from([0]);global=require("module$node_modules$mqtt_packet$numbers");const nextTick=require("module$node_modules$process_nextick_args$index").nextTick,debug=require("module$node_modules$debug$src$browser")("mqtt-packet:writeToStream"),
numCache=global.cache,generateNumber=global.generateNumber,generateCache=global.generateCache,genBufVariableByteInt=global.genBufVariableByteInt,generate4ByteBuffer=global.generate4ByteBuffer;let writeNumber=writeNumberCached,toGenerate=!0;Object.defineProperty(generate,"cacheNumbers",{get(){return writeNumber===writeNumberCached},set(value){value?(numCache&&0!==Object.keys(numCache).length||(toGenerate=!0),writeNumber=writeNumberCached):(toGenerate=!1,writeNumber=writeNumberGenerated)}});const varByteIntCache=
{};module.exports=generate}
//# sourceMappingURL=module$node_modules$mqtt_packet$writeToStream.js.map
